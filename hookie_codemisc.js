var internetExplorer=document.selection&&window.ActiveXObject&&/MSIE/.test(navigator.userAgent);var oldIE=internetExplorer&&/MSIE\s+[4-8]\b/.test(navigator.userAgent);var webkit=/AppleWebKit/.test(navigator.userAgent);var safari=/Apple Computer, Inc/.test(navigator.vendor);var gecko=navigator.userAgent.match(/gecko\/(\d{8})/i);if(gecko){gecko=Number(gecko[1])}var mac=/Mac/.test(navigator.platform);var brokenOpera=window.opera&&/Version\/10.[56]/.test(navigator.userAgent);var slowWebkit=/AppleWebKit\/533/.test(navigator.userAgent);function makeWhiteSpace(c){var b=[],a=true;for(;c>0;c--){b.push((a||c==1)?nbsp:" ");a^=true}return b.join("")}function fixSpaces(a){if(a.charAt(0)==" "){a=nbsp+a.slice(1)}return a.replace(/\t/g,function(){return makeWhiteSpace(indentUnit)}).replace(/[ \u00a0]{2,}/g,function(b){return makeWhiteSpace(b.length)})}function cleanText(a){return a.replace(/\u00a0/g," ").replace(/\u200b/g,"")}function makePartSpan(b){var c=b;if(b.nodeType==3){c=b.nodeValue}else{b=document.createTextNode(c)}var a=document.createElement("span");a.isPart=true;a.appendChild(b);a.currentText=c;return a}function alwaysZero(){return 0}var webkitLastLineHack=webkit?function(a){var c=a.lastChild;if(!c||!c.hackBR){var b=document.createElement("br");b.hackBR=true;a.appendChild(b)}}:function(){};function asEditorLines(a){var b=makeWhiteSpace(indentUnit);return map(a.replace(/\t/g,b).replace(/\u00a0/g," ").replace(/\r\n?/g,"\n").split("\n"),fixSpaces)}var Editor=(function(){var f={P:true,DIV:true,LI:true};function c(m,l){var k=[];var o=true;function n(p,q){if(p.nodeType==3){var r=p.nodeValue=fixSpaces(p.nodeValue.replace(/[\r\u200b]/g,"").replace(/\n/g," "));if(r.length){o=false}k.push(p)}else{if(isBR(p)&&p.childNodes.length==0){o=true;k.push(p)}else{for(var s=p.firstChild;s;s=s.nextSibling){n(s)}if(!o&&f.hasOwnProperty(p.nodeName.toUpperCase())){o=true;if(!l||!q){k.push(document.createElement("br"))}}}}}n(m,true);return k}function d(k){var l=[];function p(v){var u=v.parentNode;var t=v.nextSibling;return function(w){u.insertBefore(w,t)}}var r=null;var q=true;function m(t){var u="\n";if(t.nodeType==3){select.snapshotChanged();t=makePartSpan(t);u=t.currentText;q=false}else{if(q&&window.opera){r(makePartSpan(""))}q=true}t.dirty=true;l.push(t);r(t);return u}function n(v,t){var w=c(v,t);for(var u=0;u<w.length;u++){w[u]=m(w[u])}return w.join("")}function s(t){if(t.isPart&&t.childNodes.length==1&&t.firstChild.nodeType==3){var u=t.firstChild.nodeValue;t.dirty=t.dirty||u!=t.currentText;t.currentText=u;return !/[\n\t\r]/.test(t.currentText)}return false}function o(){if(!k){throw StopIteration}var u=k;k=u.nextSibling;if(s(u)){l.push(u);q=false;return u.currentText}else{if(isBR(u)){if(q&&window.opera){u.parentNode.insertBefore(makePartSpan(""),u)}l.push(u);q=true;return"\n"}else{var t=!u.nextSibling;r=p(u);removeElement(u);return n(u,t)}}}return{next:o,nodes:l}}function g(k){return isBR(k)?1:k.currentText.length}function h(k){while(k&&!isBR(k)){k=k.previousSibling}return k}function j(l,k){if(!l){l=k.firstChild}else{if(isBR(l)){l=l.nextSibling}}while(l&&!isBR(l)){l=l.nextSibling}return l}function b(){return new Date().getTime()}function i(m,o,q,k){this.editor=m;this.history=m.history;this.history.commit();this.valid=!!o;this.atOccurrence=false;if(k==undefined){k=typeof o=="string"&&o==o.toLowerCase()}function r(u){var t=cleanText(m.history.textAfter(u));return(k?t.toLowerCase():t)}var l={node:null,offset:0},s=this;if(q&&typeof q=="object"&&typeof q.character=="number"){m.checkLine(q.line);var p={node:q.line,offset:q.character};this.pos={from:p,to:p}}else{if(q){this.pos={from:select.cursorPos(m.container,true)||l,to:select.cursorPos(m.container,false)||l}}else{this.pos={from:l,to:l}}}if(typeof o!="string"){this.matches=function(v,w,z){if(v){var t=r(w).slice(0,z),u=t.match(o),A=0;while(u){var x=t.indexOf(u[0]);A+=x;t=t.slice(x+1);var y=t.match(o);if(y){u=y}else{break}}}else{var t=r(w).slice(z),u=t.match(o),A=u&&z+t.indexOf(u[0])}if(u){s.currentMatch=u;return{from:{node:w,offset:A},to:{node:w,offset:A+u[0].length}}}};return}if(k){o=o.toLowerCase()}var n=o.split("\n");this.matches=(n.length==1)?function(w,x,y){var u=r(x),t=o.length,v;if(w?(y>=t&&(v=u.lastIndexOf(o,y-t))!=-1):(v=u.indexOf(o,y))!=-1){return{from:{node:x,offset:v},to:{node:x,offset:v+t}}}}:function(y,t,u){var A=(y?n.length-1:0),w=n[A],B=r(t);var x=(y?B.indexOf(w)+w.length:B.lastIndexOf(w));if(y?x>=u||x!=w.length:x<=u||x!=B.length-w.length){return}var z=t;while(true){if(y&&!z){return}z=(y?this.history.nodeBefore(z):this.history.nodeAfter(z));if(!y&&!z){return}B=r(z);w=n[y?--A:++A];if(A>0&&A<n.length-1){if(B!=w){return}else{continue}}var v=(y?B.lastIndexOf(w):B.indexOf(w)+w.length);if(y?v!=B.length-w.length:v!=w.length){return}return{from:{node:y?z:t,offset:y?v:x},to:{node:y?t:z,offset:y?x:v}}}}}i.prototype={findNext:function(){return this.find(false)},findPrevious:function(){return this.find(true)},find:function(l){if(!this.valid){return false}var k=this,q=l?this.pos.from:this.pos.to,o=q.node,p=q.offset;if(o&&!o.parentNode){o=null;p=0}function n(){var r={node:o,offset:p};k.pos={from:r,to:r};k.atOccurrence=false;return false}while(true){if(this.pos=this.matches(l,o,p)){this.atOccurrence=true;return true}if(l){if(!o){return n()}o=this.history.nodeBefore(o);p=this.history.textAfter(o).length}else{var m=this.history.nodeAfter(o);if(!m){p=this.history.textAfter(o).length;return n()}o=m;p=0}}},select:function(){if(this.atOccurrence){select.setCursorPos(this.editor.container,this.pos.from,this.pos.to);select.scrollToCursor(this.editor.container)}},replace:function(m){if(this.atOccurrence){var k=this.currentMatch;if(k){m=m.replace(/\\(\d)/,function(n,o){return k[o]})}var l=this.editor.replaceRange(this.pos.from,this.pos.to,m);this.pos.to=l;this.atOccurrence=false}},position:function(){if(this.atOccurrence){return{line:this.pos.from.node,character:this.pos.from.offset}}}};function e(n){this.options=n;window.indentUnit=n.indentUnit;var k=this.container=document.body;this.history=new UndoHistory(k,n.undoDepth,n.undoDelay,this);var m=this;if(!e.Parser){throw"No parser loaded."}if(n.parserConfig&&e.Parser.configure){e.Parser.configure(n.parserConfig)}if(!n.readOnly&&!internetExplorer){select.setCursorPos(k,{node:null,offset:0})}this.dirty=[];this.importCode(n.content||"");this.history.onChange=n.onChange;if(!n.readOnly){if(n.continuousScanning!==false){this.scanner=this.documentScanner(n.passTime);this.delayScanning()}function o(){if(document.body.contentEditable!=undefined&&internetExplorer){document.body.contentEditable="true"}else{document.designMode="on"}if(internetExplorer&&n.height!="dynamic"){document.body.style.minHeight=(window.frameElement.clientHeight-2*document.body.offsetTop-5)+"px"}document.documentElement.style.borderWidth="0";if(!n.textWrapping){k.style.whiteSpace="nowrap"}}try{o()}catch(q){var l=addEventHandler(document,"focus",function(){l();o()},true)}addEventHandler(document,"keydown",method(this,"keyDown"));addEventHandler(document,"keypress",method(this,"keyPress"));addEventHandler(document,"keyup",method(this,"keyUp"));function p(){m.cursorActivity(false)}addEventHandler(internetExplorer?document.body:window,"mouseup",p);addEventHandler(document.body,"cut",p);if(gecko){addEventHandler(window,"pagehide",function(){m.unloaded=true})}addEventHandler(document.body,"paste",function(r){p();var t=null;try{var u=r.clipboardData||window.clipboardData;if(u){t=u.getData("Text")}}catch(s){}if(t!==null){r.stop();m.replaceSelection(t);select.scrollToCursor(m.container)}});if(this.options.autoMatchParens){addEventHandler(document.body,"click",method(this,"scheduleParenHighlight"))}}else{if(!n.textWrapping){k.style.whiteSpace="nowrap"}}}function a(k){return(k>=16&&k<=18)||(k>=33&&k<=40)}e.prototype={importCode:function(o){var k=asEditorLines(o),n=1000;if(!this.options.incrementalLoading||k.length<n){this.history.push(null,null,k);this.history.reset()}else{var p=0,l=this;function m(){var q=k.slice(p,p+n);q.push("");l.history.push(l.history.nodeBefore(null),null,q);l.history.reset();p+=n;if(p<k.length){parent.setTimeout(m,1000)}}m()}},getCode:function(){if(!this.container.firstChild){return""}var k=[];select.markSelection();forEach(d(this.container.firstChild),method(k,"push"));select.selectMarked();if(webkit&&this.container.lastChild.hackBR){k.pop()}webkitLastLineHack(this.container);return cleanText(k.join(""))},checkLine:function(k){if(k===false||!(k==null||k.parentNode==this.container||k.hackBR)){throw parent.CodeMirror.InvalidLineHandle}},cursorPosition:function(l){if(l==null){l=true}var k=select.cursorPos(this.container,l);if(k){return{line:k.node,character:k.offset}}else{return{line:null,character:0}}},firstLine:function(){return null},lastLine:function(){var k=this.container.lastChild;if(k){k=h(k)}if(k&&k.hackBR){k=h(k.previousSibling)}return k},nextLine:function(l){this.checkLine(l);var k=j(l,this.container);if(!k||k.hackBR){return false}else{return k}},prevLine:function(k){this.checkLine(k);if(k==null){return false}return h(k.previousSibling)},visibleLineCount:function(){var k=this.container.firstChild;while(k&&isBR(k)){k=k.nextSibling}if(!k){return false}var l=(window.innerHeight||document.documentElement.clientHeight||document.body.clientHeight);return Math.floor(l/k.offsetHeight)},selectLines:function(o,k,n,m){this.checkLine(o);var p={node:o,offset:k},l=null;if(m!==undefined){this.checkLine(n);l={node:n,offset:m}}select.setCursorPos(this.container,p,l);select.scrollToCursor(this.container)},lineContent:function(k){var l=[];for(k=k?k.nextSibling:this.container.firstChild;k&&!isBR(k);k=k.nextSibling){l.push(nodeText(k))}return cleanText(l.join(""))},setLineContent:function(k,l){this.history.commit();this.replaceRange({node:k,offset:0},{node:k,offset:this.history.textAfter(k).length},l);this.addDirtyNode(k);this.scheduleHighlight()},removeLine:function(k){var m=k?k.nextSibling:this.container.firstChild;while(m){var l=m.nextSibling;removeElement(m);if(isBR(m)){break}m=l}this.addDirtyNode(k);this.scheduleHighlight()},insertIntoLine:function(m,k,o){var p=null;if(k=="end"){p=j(m,this.container)}else{for(var r=m?m.nextSibling:this.container.firstChild;r;r=r.nextSibling){if(k==0){p=r;break}var q=nodeText(r);if(q.length>k){p=r.nextSibling;o=q.slice(0,k)+o+q.slice(k);removeElement(r);break}k-=q.length}}var l=asEditorLines(o);for(var n=0;n<l.length;n++){if(n>0){this.container.insertBefore(document.createElement("BR"),p)}this.container.insertBefore(makePartSpan(l[n]),p)}this.addDirtyNode(m);this.scheduleHighlight()},selectedText:function(){var l=this.history;l.commit();var o=select.cursorPos(this.container,true),k=select.cursorPos(this.container,false);if(!o||!k){return""}if(o.node==k.node){return l.textAfter(o.node).slice(o.offset,k.offset)}var m=[l.textAfter(o.node).slice(o.offset)];for(var n=l.nodeAfter(o.node);n!=k.node;n=l.nodeAfter(n)){m.push(l.textAfter(n))}m.push(l.textAfter(k.node).slice(0,k.offset));return cleanText(m.join("\n"))},replaceSelection:function(l){this.history.commit();var m=select.cursorPos(this.container,true),k=select.cursorPos(this.container,false);if(!m||!k){return}k=this.replaceRange(m,k,l);select.setCursorPos(this.container,k);webkitLastLineHack(this.container)},cursorCoords:function(k,p){var l=select.cursorPos(this.container,k);if(!l){return null}var m=l.offset,n=l.node,s=this;function r(v,u){var w=-(document.body.scrollTop||document.documentElement.scrollTop||0),t=-(document.body.scrollLeft||document.documentElement.scrollLeft||0)+u;forEach([v,p?null:window.frameElement],function(x){while(x){t+=x.offsetLeft;w+=x.offsetTop;x=x.offsetParent}});return{x:t,y:w,yBot:w+v.offsetHeight}}function q(v,u){var t=document.createElement("SPAN");t.appendChild(document.createTextNode(v));try{return u(t)}finally{if(t.parentNode){t.parentNode.removeChild(t)}}}while(m){n=n?n.nextSibling:this.container.firstChild;var o=nodeText(n);if(m<o.length){return q(o.substr(0,m),function(t){t.style.position="absolute";t.style.visibility="hidden";t.className=n.className;s.container.appendChild(t);return r(n,t.offsetWidth)})}m-=o.length}if(n&&isSpan(n)){return r(n,n.offsetWidth)}else{if(n&&n.nextSibling&&isSpan(n.nextSibling)){return r(n.nextSibling,0)}else{return q("\u200b",function(t){if(n){n.parentNode.insertBefore(t,n.nextSibling)}else{s.container.insertBefore(t,s.container.firstChild)}return r(t,0)})}}},reroutePasteEvent:function(){if(this.capturingPaste||window.opera||(gecko&&gecko>=20101026)){return}this.capturingPaste=true;var n=window.frameElement.CodeMirror.textareaHack;var m=this.cursorCoords(true,true);n.style.top=m.y+"px";if(oldIE){var l=select.getBookmark(this.container);if(l){this.selectionSnapshot=l}}parent.focus();n.value="";n.focus();var k=this;parent.setTimeout(function(){k.capturingPaste=false;window.focus();if(k.selectionSnapshot){window.select.setBookmark(k.container,k.selectionSnapshot)}var o=n.value;if(o){k.replaceSelection(o);select.scrollToCursor(k.container)}},10)},replaceRange:function(p,o,n){var m=asEditorLines(n);m[0]=this.history.textAfter(p.node).slice(0,p.offset)+m[0];var l=m[m.length-1];m[m.length-1]=l+this.history.textAfter(o.node).slice(o.offset);var k=this.history.nodeAfter(o.node);this.history.push(p.node,k,m);return{node:this.history.nodeBefore(k),offset:l.length}},getSearchCursor:function(l,k,m){return new i(this,l,k,m)},reindent:function(){if(this.container.firstChild){this.indentRegion(null,this.container.lastChild)}},reindentSelection:function(l){if(!select.somethingSelected()){this.indentAtCursor(l)}else{var m=select.selectionTopNode(this.container,true),k=select.selectionTopNode(this.container,false);if(m===false||k===false){return}this.indentRegion(m,k,l,true)}},grabKeys:function(k,l){this.frozen=k;this.keyFilter=l},ungrabKeys:function(){this.frozen="leave"},setParser:function(k,l){e.Parser=window[k];l=l||this.options.parserConfig;if(l&&e.Parser.configure){e.Parser.configure(l)}if(this.container.firstChild){forEach(this.container.childNodes,function(m){if(m.nodeType!=3){m.dirty=true}});this.addDirtyNode(this.firstChild);this.scheduleHighlight()}},keyDown:function(m){if(this.frozen=="leave"){this.frozen=null;this.keyFilter=null}if(this.frozen&&(!this.keyFilter||this.keyFilter(m.keyCode,m))){m.stop();this.frozen(m);return}var l=m.keyCode;this.delayScanning();if(this.options.autoMatchParens){this.scheduleParenHighlight()}if(l==13){if(m.ctrlKey&&!m.altKey){this.reparseBuffer()}else{select.insertNewlineAtCursor();var o=this.options.enterMode;if(o!="flat"){this.indentAtCursor(o=="keep"?"keep":undefined)}select.scrollToCursor(this.container)}m.stop()}else{if(l==9&&this.options.tabMode!="default"&&!m.ctrlKey){this.handleTab(!m.shiftKey);m.stop()}else{if(l==32&&m.shiftKey&&this.options.tabMode=="default"){this.handleTab(true);m.stop()}else{if(l==36&&!m.shiftKey&&!m.ctrlKey){if(this.home()){m.stop()}}else{if(l==35&&!m.shiftKey&&!m.ctrlKey){if(this.end()){m.stop()}}else{if(l==33&&!m.shiftKey&&!m.ctrlKey&&!gecko){if(this.pageUp()){m.stop()}}else{if(l==34&&!m.shiftKey&&!m.ctrlKey&&!gecko){if(this.pageDown()){m.stop()}}else{if((l==219||l==221)&&m.ctrlKey&&!m.altKey){this.highlightParens(m.shiftKey,true);m.stop()}else{if(m.metaKey&&!m.shiftKey&&(l==37||l==39)){var n=select.selectionTopNode(this.container);if(n===false||!this.container.firstChild){return}if(l==37){select.focusAfterNode(h(n),this.container)}else{var k=j(n,this.container);select.focusAfterNode(k?k.previousSibling:this.container.lastChild,this.container)}m.stop()}else{if((m.ctrlKey||m.metaKey)&&!m.altKey){if((m.shiftKey&&l==90)||l==89){select.scrollToNode(this.history.redo());m.stop()}else{if(l==90||(safari&&l==8)){select.scrollToNode(this.history.undo());m.stop()}else{if(l==83&&this.options.saveFunction){this.options.saveFunction();m.stop()}else{if(l==86&&!mac){this.reroutePasteEvent()}}}}}}}}}}}}}}},keyPress:function(n){var k=this.options.electricChars&&e.Parser.electricChars,l=this;if((this.frozen&&(!this.keyFilter||this.keyFilter(n.keyCode||n.code,n)))||n.code==13||(n.code==9&&this.options.tabMode!="default")||(n.code==32&&n.shiftKey&&this.options.tabMode=="default")){n.stop()}else{if(mac&&(n.ctrlKey||n.metaKey)&&n.character=="v"){this.reroutePasteEvent()}else{if(k&&k.indexOf(n.character)!=-1){parent.setTimeout(function(){l.indentAtCursor(null)},0)}else{if(brokenOpera){if(n.code==8){var o=select.selectionTopNode(this.container),l=this,m=o?o.nextSibling:this.container.firstChild;if(o!==false&&m&&isBR(m)){parent.setTimeout(function(){if(select.selectionTopNode(l.container)==m){select.focusAfterNode(m.previousSibling,l.container)}},20)}}else{if(n.code==46){var o=select.selectionTopNode(this.container),l=this;if(o&&isBR(o)){parent.setTimeout(function(){if(select.selectionTopNode(l.container)!=o){select.focusAfterNode(o,l.container)}},20)}}}}else{if(slowWebkit){var o=select.selectionTopNode(this.container),m=o?o.nextSibling:this.container.firstChild;if(o&&m&&isBR(m)&&!isBR(o)){var p=document.createTextNode("\u200b");this.container.insertBefore(p,m);parent.setTimeout(function(){if(p.nodeValue=="\u200b"){removeElement(p)}else{p.nodeValue=p.nodeValue.replace("\u200b","")}},20)}}}}}}if(webkit&&!this.options.textWrapping){setTimeout(function(){var q=select.selectionTopNode(l.container,true);if(q&&q.nodeType==3&&q.previousSibling&&isBR(q.previousSibling)&&q.nextSibling&&isBR(q.nextSibling)){q.parentNode.replaceChild(document.createElement("BR"),q.previousSibling)}},50)}},keyUp:function(k){this.cursorActivity(a(k.keyCode))},indentLineAfter:function(k,p){function t(w){var v=w?w.nextSibling:u.container.firstChild;if(!v||!hasClass(v,"whitespace")){return null}return v}var u=this,r=t(k);var l=0,s=r?r.currentText.length:0;var o=r?r.nextSibling:(k?k.nextSibling:this.container.firstChild);if(p=="keep"){if(k){var q=t(h(k.previousSibling));if(q){l=q.currentText.length}}}else{var n=(k&&o&&o.currentText)?o.currentText:"";if(p!=null&&this.options.tabMode!="indent"){l=p?s+indentUnit:Math.max(0,s-indentUnit)}else{if(k){l=k.indentation(n,s,p,o)}else{if(e.Parser.firstIndentation){l=e.Parser.firstIndentation(n,s,p,o)}}}}var m=l-s;if(m<0){if(l==0){if(o){select.snapshotMove(r.firstChild,o.firstChild||o,0)}removeElement(r);r=null}else{select.snapshotMove(r.firstChild,r.firstChild,m,true);r.currentText=makeWhiteSpace(l);r.firstChild.nodeValue=r.currentText}}else{if(m>0){if(r){r.currentText=makeWhiteSpace(l);r.firstChild.nodeValue=r.currentText;select.snapshotMove(r.firstChild,r.firstChild,m,true)}else{r=makePartSpan(makeWhiteSpace(l));r.className="whitespace";if(k){insertAfter(r,k)}else{this.container.insertBefore(r,this.container.firstChild)}select.snapshotMove(o&&(o.firstChild||o),r.firstChild,l,false,true)}}else{if(r){select.snapshotMove(r.firstChild,r.firstChild,l,false)}}}if(m!=0){this.addDirtyNode(k)}},highlightAtCursor:function(){var l=select.selectionTopNode(this.container,true);var k=select.selectionTopNode(this.container,false);if(l===false||k===false){return false}select.markSelection();if(this.highlight(l,j(k,this.container),true,20)===false){return false}select.selectMarked();return true},handleTab:function(k){if(this.options.tabMode=="spaces"&&!select.somethingSelected()){select.insertTabAtCursor()}else{this.reindentSelection(k)}},home:function(){var l=select.selectionTopNode(this.container,true),m=l;if(l===false||!(!l||l.isPart||isBR(l))||!this.container.firstChild){return false}while(l&&!isBR(l)){l=l.previousSibling}var k=l?l.nextSibling:this.container.firstChild;if(k&&k!=m&&k.isPart&&hasClass(k,"whitespace")){select.focusAfterNode(k,this.container)}else{select.focusAfterNode(l,this.container)}select.scrollToCursor(this.container);return true},end:function(){var k=select.selectionTopNode(this.container,true);if(k===false){return false}k=j(k,this.container);if(!k){return false}select.focusAfterNode(k.previousSibling,this.container);select.scrollToCursor(this.container);return true},pageUp:function(){var k=this.cursorPosition().line,m=this.visibleLineCount();if(k===false||m===false){return false}m-=2;for(var l=0;l<m;l++){k=this.prevLine(k);if(k===false){break}}if(l==0){return false}select.setCursorPos(this.container,{node:k,offset:0});select.scrollToCursor(this.container);return true},pageDown:function(){var k=this.cursorPosition().line,n=this.visibleLineCount();if(k===false||n===false){return false}n-=2;for(var l=0;l<n;l++){var m=this.nextLine(k);if(m===false){break}k=m}if(l==0){return false}select.setCursorPos(this.container,{node:k,offset:0});select.scrollToCursor(this.container);return true},scheduleParenHighlight:function(){if(this.parenEvent){parent.clearTimeout(this.parenEvent)}var k=this;this.parenEvent=parent.setTimeout(function(){k.highlightParens()},300)},highlightParens:function(y,l){var w=this,o=this.options.markParen;if(typeof o=="string"){o=[o,o]}function n(A,z){if(!A){return}if(!o){A.style.fontWeight="bold";A.style.color=z?"#8F8":"#F88"}else{if(o.call){o(A,z)}else{A.className+=" "+o[z?0:1]}}}function t(z){if(!z){return}if(o&&!o.call){removeClass(removeClass(z,o[0]),o[1])}else{if(w.options.unmarkParen){w.options.unmarkParen(z)}else{z.style.fontWeight="";z.style.color=""}}}if(!l&&w.highlighted){t(w.highlighted[0]);t(w.highlighted[1])}if(!window||!window.parent||!window.select){return}if(this.parenEvent){parent.clearTimeout(this.parenEvent)}this.parenEvent=null;function u(A){if(A.currentText){var z=A.currentText.match(/^[\s\u00a0]*([\(\)\[\]{}])[\s\u00a0]*$/);return z&&z[1]}}function q(z){return/[\(\[\{]/.test(z)}var k,v=select.selectionTopNode(this.container,true);if(!v||!this.highlightAtCursor()){return}v=select.selectionTopNode(this.container,true);if(!(v&&((k=u(v))||(v=v.nextSibling)&&(k=u(v))))){return}var s=v.className,m=q(k),p=matching[k];function r(){var z=[],B,A=true;for(var C=v;C;C=m?C.nextSibling:C.previousSibling){if(C.className==s&&isSpan(C)&&(B=u(C))){if(q(B)==m){z.push(B)}else{if(!z.length){A=false}else{if(z.pop()!=matching[B]){A=false}}}if(!z.length){break}}else{if(C.dirty||!isSpan(C)&&!isBR(C)){return{node:C,status:"dirty"}}}}return{node:C,status:C&&A}}while(true){var x=r();if(x.status=="dirty"){this.highlight(x.node,j(x.node));x.node.dirty=false;continue}else{n(v,x.status);n(x.node,x.status);if(l){parent.setTimeout(function(){t(v);t(x.node)},500)}else{w.highlighted=[v,x.node]}if(y&&x.node){select.focusAfterNode(x.node.previousSibling,this.container)}break}}},indentAtCursor:function(k){if(!this.container.firstChild){return}if(!this.highlightAtCursor()){return}var l=select.selectionTopNode(this.container,false);if(l===false){return}select.markSelection();this.indentLineAfter(h(l),k);select.selectMarked()},indentRegion:function(q,k,p,n){var o=(q=h(q)),m=q&&h(q.previousSibling);if(!isBR(k)){k=j(k,this.container)}this.addDirtyNode(q);do{var l=j(o,this.container);if(o){this.highlight(m,l,true)}this.indentLineAfter(o,p);m=o;o=l}while(o!=k);if(n){select.setCursorPos(this.container,{node:q,offset:0},{node:k,offset:0})}},cursorActivity:function(l){if(this.unloaded){window.document.designMode="off";window.document.designMode="on";this.unloaded=false}if(oldIE){this.container.createTextRange().execCommand("unlink");clearTimeout(this.saveSelectionSnapshot);var k=this;this.saveSelectionSnapshot=setTimeout(function(){var o=select.getBookmark(k.container);if(o){k.selectionSnapshot=o}},200)}var m=this.options.onCursorActivity;if(!l||m){var n=select.selectionTopNode(this.container,false);if(n===false||!this.container.firstChild){return}n=n||this.container.firstChild;if(m){m(n)}if(!l){this.scheduleHighlight();this.addDirtyNode(n)}}},reparseBuffer:function(){forEach(this.container.childNodes,function(k){k.dirty=true});if(this.container.firstChild){this.addDirtyNode(this.container.firstChild)}},addDirtyNode:function(l){l=l||this.container.firstChild;if(!l){return}for(var k=0;k<this.dirty.length;k++){if(this.dirty[k]==l){return}}if(l.nodeType!=3){l.dirty=true}this.dirty.push(l)},allClean:function(){return !this.dirty.length},scheduleHighlight:function(){var k=this;parent.clearTimeout(this.highlightTimeout);this.highlightTimeout=parent.setTimeout(function(){k.highlightDirty()},this.options.passDelay)},getDirtyNode:function(){while(this.dirty.length>0){var k=this.dirty.pop();try{while(k&&k.parentNode!=this.container){k=k.parentNode}if(k&&(k.dirty||k.nodeType==3)){return k}}catch(l){}}return null},highlightDirty:function(m){if(!window||!window.parent||!window.select){return false}if(!this.options.readOnly){select.markSelection()}var n,l=m?null:b()+this.options.passTime;while((b()<l||m)&&(n=this.getDirtyNode())){var k=this.highlight(n,l);if(k&&k.node&&k.dirty){this.addDirtyNode(k.node.nextSibling)}}if(!this.options.readOnly){select.selectMarked()}if(n){this.scheduleHighlight()}return this.dirty.length==0},documentScanner:function(k){var l=this,m=null;return function(){if(!window||!window.parent||!window.select){return}if(m&&m.parentNode!=l.container){m=null}select.markSelection();var n=l.highlight(m,b()+k,true);select.selectMarked();var o=n?(n.node&&n.node.nextSibling):null;m=(m==o)?null:o;l.delayScanning()}},delayScanning:function(){if(this.scanner){parent.clearTimeout(this.documentScan);this.documentScan=parent.setTimeout(this.scanner,this.options.continuousScanning)}},highlight:function(z,D,B,v){var t=this.container,u=this,p=this.options.activeTokens;var n=(typeof D=="number"?D:null);if(!t.firstChild){return false}while(z&&(!z.parserFromHere||z.dirty)){if(v!=null&&isBR(z)&&(--v)<0){return false}z=z.previousSibling}if(z&&!z.nextSibling){return false}function q(F,E){return !E.reduced&&E.currentText==F.value&&E.className==F.style}function l(E,F){E.currentText=E.currentText.substring(F);E.reduced=true}function r(F){var E=makePartSpan(F.value);E.className=F.style;return E}function A(F){if(F){var E=F.oldNextSibling;if(y||E===undefined||F.nextSibling!=E){u.history.touch(F)}F.oldNextSibling=F.nextSibling}else{var E=u.container.oldFirstChild;if(y||E===undefined||u.container.firstChild!=E){u.history.touch(null)}u.container.oldFirstChild=u.container.firstChild}}var m=d(z?z.nextSibling:t.firstChild),o=stringStream(m),s=z?z.parserFromHere(o):e.Parser.make(o);function w(E){return(E.previousSibling==null||isBR(E.previousSibling))&&(E.nextSibling==null||isBR(E.nextSibling))}var x={current:null,get:function(){if(!this.current){this.current=m.nodes.shift()}return this.current},next:function(){this.current=null},remove:function(){t.removeChild(this.get());this.current=null},getNonEmpty:function(){var F=this.get();while(F&&isSpan(F)&&F.currentText==""){if(window.opera&&w(F)){this.next();F=this.get()}else{var E=F;this.remove();F=this.get();select.snapshotMove(E.firstChild,F&&(F.firstChild||F),0)}}return F}};var y=false,C=true,k=0;forEach(s,function(G){var F=x.getNonEmpty();if(G.value=="\n"){if(!isBR(F)){throw"Parser out of sync. Expected BR."}if(F.dirty||!F.indentation){y=true}A(z);z=F;F.parserFromHere=s.copy();F.indentation=G.indentation||alwaysZero;F.dirty=false;if(n==null&&F==D){throw StopIteration}if((n!=null&&b()>=n)||(!y&&!C&&k>1&&!B)){throw StopIteration}C=y;y=false;k=0;x.next()}else{if(!isSpan(F)){throw"Parser out of sync. Expected SPAN."}if(F.dirty){y=true}k++;if(q(G,F)){if(p&&F.dirty){p(F,G,u)}F.dirty=false;x.next()}else{y=true;var E=r(G);t.insertBefore(E,F);if(p){p(E,G,u)}var J=G.value.length;var I=0;while(J>0){F=x.get();var H=F.currentText.length;select.snapshotReplaceNode(F.firstChild,E.firstChild,J,I);if(H>J){l(F,J);J=0}else{J-=H;I+=H;x.remove()}}}}});A(z);webkitLastLineHack(this.container);return{node:x.getNonEmpty(),dirty:y}}};return e})();addEventHandler(window,"load",function(){var a=window.frameElement.CodeMirror;var b=a.editor=new Editor(a.options);parent.setTimeout(method(a,"init"),0)});

var select={};(function(){select.ie_selection=!(window.getSelection&&document.createRange&&document.createRange().endContainer);function topLevelNodeAt(node,top){while(node&&node.parentNode!=top){node=node.parentNode}return node}function topLevelNodeBefore(node,top){while(!node.previousSibling&&node.parentNode!=top){node=node.parentNode}return topLevelNodeAt(node.previousSibling,top)}var fourSpaces="\u00a0\u00a0\u00a0\u00a0";select.scrollToNode=function(node,cursor){if(!node){return}var element=node,body=document.body,html=document.documentElement,atEnd=!element.nextSibling||!element.nextSibling.nextSibling||!element.nextSibling.nextSibling.nextSibling;var compensateHack=0;while(element&&!element.offsetTop){compensateHack++;element=element.previousSibling}if(compensateHack==0){atEnd=false}if(webkit&&element&&element.offsetTop==5&&element.offsetLeft==5){return}var y=compensateHack*(element?element.offsetHeight:0),x=0,width=(node?node.offsetWidth:0),pos=element;while(pos&&pos.offsetParent){y+=pos.offsetTop;if(!isBR(pos)){x+=pos.offsetLeft}pos=pos.offsetParent}var scroll_x=body.scrollLeft||html.scrollLeft||0,scroll_y=body.scrollTop||html.scrollTop||0,scroll=false,screen_width=window.innerWidth||html.clientWidth||0;if(cursor||width<screen_width){if(cursor){var off=select.offsetInNode(node),size=nodeText(node).length;if(size){x+=width*(off/size)}}var screen_x=x-scroll_x;if(screen_x<0||screen_x>screen_width){scroll_x=x;scroll=true}}var screen_y=y-scroll_y;if(screen_y<0||atEnd||screen_y>(window.innerHeight||html.clientHeight||0)-50){scroll_y=atEnd?1000000:y;scroll=true}if(scroll){window.scrollTo(scroll_x,scroll_y)}};select.scrollToCursor=function(container){select.scrollToNode(select.selectionTopNode(container,true)||container.firstChild,true)};var currentSelection=null;select.snapshotChanged=function(){if(currentSelection){currentSelection.changed=true}};function baseNodeAfter(node){var next=node.nextSibling;if(next){while(next.firstChild){next=next.firstChild}if(next.nodeType==3||isBR(next)){return next}else{return baseNodeAfter(next)}}else{var parent=node.parentNode;while(parent&&!parent.nextSibling){parent=parent.parentNode}return parent&&baseNodeAfter(parent)}}select.snapshotReplaceNode=function(from,to,length,offset){if(!currentSelection){return}function replace(point){if(from==point.node){currentSelection.changed=true;if(length&&point.offset>length){point.offset-=length}else{point.node=to;point.offset+=(offset||0)}}else{if(select.ie_selection&&point.offset==0&&point.node==baseNodeAfter(from)){currentSelection.changed=true}}}replace(currentSelection.start);replace(currentSelection.end)};select.snapshotMove=function(from,to,distance,relative,ifAtStart){if(!currentSelection){return}function move(point){if(from==point.node&&(!ifAtStart||point.offset==0)){currentSelection.changed=true;point.node=to;if(relative){point.offset=Math.max(0,point.offset+distance)}else{point.offset=distance}}}move(currentSelection.start);move(currentSelection.end)};if(select.ie_selection){function selRange(){var sel=document.selection;if(!sel){return null}if(sel.createRange){return sel.createRange()}else{return sel.createTextRange()}}function selectionNode(start){var range=selRange();range.collapse(start);function nodeAfter(node){var found=null;while(!found&&node){found=node.nextSibling;node=node.parentNode}return nodeAtStartOf(found)}function nodeAtStartOf(node){while(node&&node.firstChild){node=node.firstChild}return{node:node,offset:0}}var containing=range.parentElement();if(!isAncestor(document.body,containing)){return null}if(!containing.firstChild){return nodeAtStartOf(containing)}var working=range.duplicate();working.moveToElementText(containing);working.collapse(true);for(var cur=containing.firstChild;cur;cur=cur.nextSibling){if(cur.nodeType==3){var size=cur.nodeValue.length;working.move("character",size)}else{working.moveToElementText(cur);working.collapse(false)}var dir=range.compareEndPoints("StartToStart",working);if(dir==0){return nodeAfter(cur)}if(dir==1){continue}if(cur.nodeType!=3){return nodeAtStartOf(cur)}working.setEndPoint("StartToEnd",range);return{node:cur,offset:size-working.text.length}}return nodeAfter(containing)}select.markSelection=function(){currentSelection=null;var sel=document.selection;if(!sel){return}var start=selectionNode(true),end=selectionNode(false);if(!start||!end){return}currentSelection={start:start,end:end,changed:false}};select.selectMarked=function(){if(!currentSelection||!currentSelection.changed){return}function makeRange(point){var range=document.body.createTextRange(),node=point.node;if(!node){range.moveToElementText(document.body);range.collapse(false)}else{if(node.nodeType==3){range.moveToElementText(node.parentNode);var offset=point.offset;while(node.previousSibling){node=node.previousSibling;offset+=(node.innerText||"").length}range.move("character",offset)}else{range.moveToElementText(node);range.collapse(true)}}return range}var start=makeRange(currentSelection.start),end=makeRange(currentSelection.end);
start.setEndPoint("StartToEnd",end);start.select()};select.offsetInNode=function(node){var range=selRange();if(!range){return 0}var range2=range.duplicate();try{range2.moveToElementText(node)}catch(e){return 0}range.setEndPoint("StartToStart",range2);return range.text.length};select.selectionTopNode=function(container,start){var range=selRange();if(!range){return false}var range2=range.duplicate();range.collapse(start);var around=range.parentElement();if(around&&isAncestor(container,around)){range2.moveToElementText(around);if(range.compareEndPoints("StartToStart",range2)==1){return topLevelNodeAt(around,container)}}function moveToNodeStart(range,node){if(node.nodeType==3){var count=0,cur=node.previousSibling;while(cur&&cur.nodeType==3){count+=cur.nodeValue.length;cur=cur.previousSibling}if(cur){try{range.moveToElementText(cur)}catch(e){return false}range.collapse(false)}else{range.moveToElementText(node.parentNode)}if(count){range.move("character",count)}}else{try{range.moveToElementText(node)}catch(e){return false}}return true}var start=0,end=container.childNodes.length-1;while(start<end){var middle=Math.ceil((end+start)/2),node=container.childNodes[middle];if(!node){return false}if(!moveToNodeStart(range2,node)){return false}if(range.compareEndPoints("StartToStart",range2)==1){start=middle}else{end=middle-1}}if(start==0){var test1=selRange(),test2=test1.duplicate();try{test2.moveToElementText(container)}catch(exception){return null}if(test1.compareEndPoints("StartToStart",test2)==0){return null}}return container.childNodes[start]||null};select.focusAfterNode=function(node,container){var range=document.body.createTextRange();range.moveToElementText(node||container);range.collapse(!node);range.select()};select.somethingSelected=function(){var range=selRange();return range&&(range.text!="")};function insertAtCursor(html){var range=selRange();if(range){range.pasteHTML(html);range.collapse(false);range.select()}}select.insertNewlineAtCursor=function(){insertAtCursor("<br>")};select.insertTabAtCursor=function(){insertAtCursor(fourSpaces)};select.cursorPos=function(container,start){var range=selRange();if(!range){return null}var topNode=select.selectionTopNode(container,start);while(topNode&&!isBR(topNode)){topNode=topNode.previousSibling}var range2=range.duplicate();range.collapse(start);if(topNode){range2.moveToElementText(topNode);range2.collapse(false)}else{try{range2.moveToElementText(container)}catch(e){return null}range2.collapse(true)}range.setEndPoint("StartToStart",range2);return{node:topNode,offset:range.text.length}};select.setCursorPos=function(container,from,to){function rangeAt(pos){var range=document.body.createTextRange();if(!pos.node){range.moveToElementText(container);range.collapse(true)}else{range.moveToElementText(pos.node);range.collapse(false)}range.move("character",pos.offset);return range}var range=rangeAt(from);if(to&&to!=from){range.setEndPoint("EndToEnd",rangeAt(to))}range.select()};select.getBookmark=function(container){var from=select.cursorPos(container,true),to=select.cursorPos(container,false);if(from&&to){return{from:from,to:to}}};select.setBookmark=function(container,mark){if(!mark){return}select.setCursorPos(container,mark.from,mark.to)}}else{function innerNode(node,offset){while(node.nodeType!=3&&!isBR(node)){var newNode=node.childNodes[offset]||node.nextSibling;offset=0;while(!newNode&&node.parentNode){node=node.parentNode;newNode=node.nextSibling}node=newNode;if(!newNode){break}}return{node:node,offset:offset}}select.markSelection=function(){var selection=window.getSelection();if(!selection||selection.rangeCount==0){return(currentSelection=null)}var range=selection.getRangeAt(0);currentSelection={start:innerNode(range.startContainer,range.startOffset),end:innerNode(range.endContainer,range.endOffset),changed:false}};select.selectMarked=function(){var cs=currentSelection;function focusIssue(){if(cs.start.node==cs.end.node&&cs.start.offset==cs.end.offset){var selection=window.getSelection();if(!selection||selection.rangeCount==0){return true}var range=selection.getRangeAt(0),point=innerNode(range.startContainer,range.startOffset);return cs.start.node!=point.node||cs.start.offset!=point.offset}}if(!cs||!(cs.changed||(webkit&&focusIssue()))){return}var range=document.createRange();function setPoint(point,which){if(point.node){if(point.offset==0){range["set"+which+"Before"](point.node)}else{range["set"+which](point.node,point.offset)}}else{range.setStartAfter(document.body.lastChild||document.body)}}setPoint(cs.end,"End");setPoint(cs.start,"Start");selectRange(range)};function selectRange(range){var selection=window.getSelection();if(!selection){return}selection.removeAllRanges();selection.addRange(range)}function selectionRange(){var selection=window.getSelection();if(!selection||selection.rangeCount==0){return false}else{return selection.getRangeAt(0)}}select.selectionTopNode=function(container,start){var range=selectionRange();if(!range){return false}var node=start?range.startContainer:range.endContainer;
var offset=start?range.startOffset:range.endOffset;if(window.opera&&!start&&range.endContainer==container&&range.endOffset==range.startOffset+1&&container.childNodes[range.startOffset]&&isBR(container.childNodes[range.startOffset])){offset--}if(node.nodeType==3){if(offset>0){return topLevelNodeAt(node,container)}else{return topLevelNodeBefore(node,container)}}else{if(node.nodeName.toUpperCase()=="HTML"){return(offset==1?null:container.lastChild)}else{if(node==container){return(offset==0)?null:node.childNodes[offset-1]}else{if(offset==node.childNodes.length){return topLevelNodeAt(node,container)}else{if(offset==0){return topLevelNodeBefore(node,container)}else{return topLevelNodeAt(node.childNodes[offset-1],container)}}}}}};select.focusAfterNode=function(node,container){var range=document.createRange();range.setStartBefore(container.firstChild||container);if(node&&!node.firstChild){range.setEndAfter(node)}else{if(node){range.setEnd(node,node.childNodes.length)}else{range.setEndBefore(container.firstChild||container)}}range.collapse(false);selectRange(range)};select.somethingSelected=function(){var range=selectionRange();return range&&!range.collapsed};select.offsetInNode=function(node){var range=selectionRange();if(!range){return 0}range=range.cloneRange();range.setStartBefore(node);return range.toString().length};select.insertNodeAtCursor=function(node){var range=selectionRange();if(!range){return}range.deleteContents();range.insertNode(node);webkitLastLineHack(document.body);if(window.opera&&isBR(node)&&isSpan(node.parentNode)){var next=node.nextSibling,p=node.parentNode,outer=p.parentNode;outer.insertBefore(node,p.nextSibling);var textAfter="";for(;next&&next.nodeType==3;next=next.nextSibling){textAfter+=next.nodeValue;removeElement(next)}outer.insertBefore(makePartSpan(textAfter,document),node.nextSibling)}range=document.createRange();range.selectNode(node);range.collapse(false);selectRange(range)};select.insertNewlineAtCursor=function(){select.insertNodeAtCursor(document.createElement("BR"))};select.insertTabAtCursor=function(){select.insertNodeAtCursor(document.createTextNode(fourSpaces))};select.cursorPos=function(container,start){var range=selectionRange();if(!range){return}var topNode=select.selectionTopNode(container,start);while(topNode&&!isBR(topNode)){topNode=topNode.previousSibling}range=range.cloneRange();range.collapse(start);if(topNode){range.setStartAfter(topNode)}else{range.setStartBefore(container)}var text=range.toString();return{node:topNode,offset:text.length}};select.setCursorPos=function(container,from,to){var range=document.createRange();function setPoint(node,offset,side){if(offset==0&&node&&!node.nextSibling){range["set"+side+"After"](node);return true}if(!node){node=container.firstChild}else{node=node.nextSibling}if(!node){return}if(offset==0){range["set"+side+"Before"](node);return true}var backlog=[];function decompose(node){if(node.nodeType==3){backlog.push(node)}else{forEach(node.childNodes,decompose)}}while(true){while(node&&!backlog.length){decompose(node);node=node.nextSibling}var cur=backlog.shift();if(!cur){return false}var length=cur.nodeValue.length;if(length>=offset){range["set"+side](cur,offset);return true}offset-=length}}to=to||from;if(setPoint(to.node,to.offset,"End")&&setPoint(from.node,from.offset,"Start")){selectRange(range)}}}})();

var stringStream=function(source){var current="";var pos=0;var accum="";function ensureChars(){while(pos==current.length){accum+=current;current="";pos=0;try{current=source.next()}catch(e){if(e!=StopIteration){throw e}else{return false}}}return true}return{peek:function(){if(!ensureChars()){return null}return current.charAt(pos)},next:function(){if(!ensureChars()){if(accum.length>0){throw"End of stringstream reached without emptying buffer ('"+accum+"')."}else{throw StopIteration}}return current.charAt(pos++)},get:function(){var temp=accum;accum="";if(pos>0){temp+=current.slice(0,pos);current=current.slice(pos);pos=0}return temp},push:function(str){current=current.slice(0,pos)+str+current.slice(pos)},lookAhead:function(str,consume,skipSpaces,caseInsensitive){function cased(str){return caseInsensitive?str.toLowerCase():str}str=cased(str);var found=false;var _accum=accum,_pos=pos;if(skipSpaces){this.nextWhileMatches(/[\s\u00a0]/)}while(true){var end=pos+str.length,left=current.length-pos;if(end<=current.length){found=str==cased(current.slice(pos,end));pos=end;break}else{if(str.slice(0,left)==cased(current.slice(pos))){accum+=current;current="";try{current=source.next()}catch(e){if(e!=StopIteration){throw e}break}pos=0;str=str.slice(left)}else{break}}}if(!(found&&consume)){current=accum.slice(_accum.length)+current;pos=_pos;accum=_accum}return found},lookAheadRegex:function(regex,consume){if(regex.source.charAt(0)!="^"){throw new Error("Regexps passed to lookAheadRegex must start with ^")}while(current.indexOf("\n",pos)==-1){try{current+=source.next()}catch(e){if(e!=StopIteration){throw e}break}}var matched=current.slice(pos).match(regex);if(matched&&consume){pos+=matched[0].length}return matched},more:function(){return this.peek()!==null},applies:function(test){var next=this.peek();return(next!==null&&test(next))},nextWhile:function(test){var next;while((next=this.peek())!==null&&test(next)){this.next()}},matches:function(re){var next=this.peek();return(next!==null&&re.test(next))},nextWhileMatches:function(re){var next;while((next=this.peek())!==null&&re.test(next)){this.next()}},equals:function(ch){return ch===this.peek()},endOfLine:function(){var next=this.peek();return next==null||next=="\n"}}};

function tokenizer(source,state){function isWhiteSpace(ch){return ch!="\n"&&/^[\s\u00a0]*$/.test(ch)}var tokenizer={state:state,take:function(type){if(typeof(type)=="string"){type={style:type,type:type}}type.content=(type.content||"")+source.get();if(!/\n$/.test(type.content)){source.nextWhile(isWhiteSpace)}type.value=type.content+source.get();return type},next:function(){if(!source.more()){throw StopIteration}var type;if(source.equals("\n")){source.next();return this.take("whitespace")}if(source.applies(isWhiteSpace)){type="whitespace"}else{while(!type){type=this.state(source,function(s){tokenizer.state=s})}}return this.take(type)}};return tokenizer};

function UndoHistory(container,maxDepth,commitDelay,editor){this.container=container;this.maxDepth=maxDepth;this.commitDelay=commitDelay;this.editor=editor;var initial={text:"",from:null,to:null};this.first=initial;this.last=initial;this.firstTouched=false;this.history=[];this.redoHistory=[];this.touched=[];this.lostundo=0}UndoHistory.prototype={scheduleCommit:function(){var self=this;parent.clearTimeout(this.commitTimeout);this.commitTimeout=parent.setTimeout(function(){self.tryCommit()},this.commitDelay)},touch:function(node){this.setTouched(node);this.scheduleCommit()},undo:function(){this.commit();if(this.history.length){var item=this.history.pop();this.redoHistory.push(this.updateTo(item,"applyChain"));this.notifyEnvironment();return this.chainNode(item)}},redo:function(){this.commit();if(this.redoHistory.length){var item=this.redoHistory.pop();this.addUndoLevel(this.updateTo(item,"applyChain"));this.notifyEnvironment();return this.chainNode(item)}},clear:function(){this.history=[];this.redoHistory=[];this.lostundo=0},historySize:function(){return{undo:this.history.length,redo:this.redoHistory.length,lostundo:this.lostundo}},push:function(from,to,lines){var chain=[];for(var i=0;i<lines.length;i++){var end=(i==lines.length-1)?to:document.createElement("br");chain.push({from:from,to:end,text:cleanText(lines[i])});from=end}this.pushChains([chain],from==null&&to==null);this.notifyEnvironment()},pushChains:function(chains,doNotHighlight){this.commit(doNotHighlight);this.addUndoLevel(this.updateTo(chains,"applyChain"));this.redoHistory=[]},chainNode:function(chains){for(var i=0;i<chains.length;i++){var start=chains[i][0],node=start&&(start.from||start.to);if(node){return node}}},reset:function(){this.history=[];this.redoHistory=[];this.lostundo=0},textAfter:function(br){return this.after(br).text},nodeAfter:function(br){return this.after(br).to},nodeBefore:function(br){return this.before(br).from},tryCommit:function(){if(!window||!window.parent||!window.UndoHistory){return}if(this.editor.highlightDirty()){this.commit(true)}else{this.scheduleCommit()}},commit:function(doNotHighlight){parent.clearTimeout(this.commitTimeout);if(!doNotHighlight){this.editor.highlightDirty(true)}var chains=this.touchedChains(),self=this;if(chains.length){this.addUndoLevel(this.updateTo(chains,"linkChain"));this.redoHistory=[];this.notifyEnvironment()}},updateTo:function(chains,updateFunc){var shadows=[],dirty=[];for(var i=0;i<chains.length;i++){shadows.push(this.shadowChain(chains[i]));dirty.push(this[updateFunc](chains[i]))}if(updateFunc=="applyChain"){this.notifyDirty(dirty)}return shadows},notifyDirty:function(nodes){forEach(nodes,method(this.editor,"addDirtyNode"));this.editor.scheduleHighlight()},notifyEnvironment:function(){if(this.onChange){this.onChange(this.editor)}if(window.frameElement&&window.frameElement.CodeMirror.updateNumbers){window.frameElement.CodeMirror.updateNumbers()}},linkChain:function(chain){for(var i=0;i<chain.length;i++){var line=chain[i];if(line.from){line.from.historyAfter=line}else{this.first=line}if(line.to){line.to.historyBefore=line}else{this.last=line}}},after:function(node){return node?node.historyAfter:this.first},before:function(node){return node?node.historyBefore:this.last},setTouched:function(node){if(node){if(!node.historyTouched){this.touched.push(node);node.historyTouched=true}}else{this.firstTouched=true}},addUndoLevel:function(diffs){this.history.push(diffs);if(this.history.length>this.maxDepth){this.history.shift();this.lostundo+=1}},touchedChains:function(){var self=this;var nullTemp=null;function temp(node){return node?node.historyTemp:nullTemp}function setTemp(node,line){if(node){node.historyTemp=line}else{nullTemp=line}}function buildLine(node){var text=[];for(var cur=node?node.nextSibling:self.container.firstChild;cur&&(!isBR(cur)||cur.hackBR);cur=cur.nextSibling){if(!cur.hackBR&&cur.currentText){text.push(cur.currentText)}}return{from:node,to:cur,text:cleanText(text.join(""))}}var lines=[];if(self.firstTouched){self.touched.push(null)}forEach(self.touched,function(node){if(node&&(node.parentNode!=self.container||node.hackBR)){return}if(node){node.historyTouched=false}else{self.firstTouched=false}var line=buildLine(node),shadow=self.after(node);if(!shadow||shadow.text!=line.text||shadow.to!=line.to){lines.push(line);setTemp(node,line)}});function nextBR(node,dir){var link=dir+"Sibling",search=node[link];while(search&&!isBR(search)){search=search[link]}return search}var chains=[];self.touched=[];forEach(lines,function(line){if(!temp(line.from)){return}var chain=[],curNode=line.from,safe=true;while(true){var curLine=temp(curNode);if(!curLine){if(safe){break}else{curLine=buildLine(curNode)}}chain.unshift(curLine);setTemp(curNode,null);if(!curNode){break}safe=self.after(curNode);curNode=nextBR(curNode,"previous")}curNode=line.to;safe=self.before(line.from);while(true){if(!curNode){break}var curLine=temp(curNode);if(!curLine){if(safe){break}else{curLine=buildLine(curNode)}}chain.push(curLine);
setTemp(curNode,null);safe=self.before(curNode);curNode=nextBR(curNode,"next")}chains.push(chain)});return chains},shadowChain:function(chain){var shadows=[],next=this.after(chain[0].from),end=chain[chain.length-1].to;while(true){shadows.push(next);var nextNode=next.to;if(!nextNode||nextNode==end){break}else{next=nextNode.historyAfter||this.before(end)}}return shadows},applyChain:function(chain){var cursor=select.cursorPos(this.container,false),self=this;function removeRange(from,to){var pos=from?from.nextSibling:self.container.firstChild;while(pos!=to){var temp=pos.nextSibling;removeElement(pos);pos=temp}}var start=chain[0].from,end=chain[chain.length-1].to;removeRange(start,end);for(var i=0;i<chain.length;i++){var line=chain[i];if(i>0){self.container.insertBefore(line.from,end)}var node=makePartSpan(fixSpaces(line.text));self.container.insertBefore(node,end);if(cursor&&cursor.node==line.from){var cursordiff=0;var prev=this.after(line.from);if(prev&&i==chain.length-1){for(var match=0;match<cursor.offset&&line.text.charAt(match)==prev.text.charAt(match);match++){}if(cursor.offset>match){cursordiff=line.text.length-prev.text.length}}select.setCursorPos(this.container,{node:line.from,offset:Math.max(0,cursor.offset+cursordiff)})}else{if(cursor&&(i==chain.length-1)&&cursor.node&&cursor.node.parentNode!=this.container){select.setCursorPos(this.container,{node:line.from,offset:line.text.length})}}}this.linkChain(chain);return start}};

function method(obj,name){return function(){obj[name].apply(obj,arguments)}}var StopIteration={toString:function(){return"StopIteration"}};function forEach(iter,f){if(iter.next){try{while(true){f(iter.next())}}catch(e){if(e!=StopIteration){throw e}}}else{for(var i=0;i<iter.length;i++){f(iter[i])}}}function map(iter,f){var accum=[];forEach(iter,function(val){accum.push(f(val))});return accum}function matcher(regexp){return function(value){return regexp.test(value)}}function hasClass(element,className){var classes=element.className;return classes&&new RegExp("(^| )"+className+"($| )").test(classes)}function removeClass(element,className){element.className=element.className.replace(new RegExp(" "+className+"\\b","g"),"");return element}function insertAfter(newNode,oldNode){var parent=oldNode.parentNode;parent.insertBefore(newNode,oldNode.nextSibling);return newNode}function removeElement(node){if(node.parentNode){node.parentNode.removeChild(node)}}function clearElement(node){while(node.firstChild){node.removeChild(node.firstChild)}}function isAncestor(node,child){while(child=child.parentNode){if(node==child){return true}}return false}var nbsp="\u00a0";var matching={"{":"}","[":"]","(":")","}":"{","]":"[",")":"("};function normalizeEvent(event){if(!event.stopPropagation){event.stopPropagation=function(){this.cancelBubble=true};event.preventDefault=function(){this.returnValue=false}}if(!event.stop){event.stop=function(){this.stopPropagation();this.preventDefault()}}if(event.type=="keypress"){event.code=(event.charCode==null)?event.keyCode:event.charCode;event.character=String.fromCharCode(event.code)}return event}function addEventHandler(node,type,handler,removeFunc){function wrapHandler(event){handler(normalizeEvent(event||window.event))}if(typeof node.addEventListener=="function"){node.addEventListener(type,wrapHandler,false);if(removeFunc){return function(){node.removeEventListener(type,wrapHandler,false)}}}else{node.attachEvent("on"+type,wrapHandler);if(removeFunc){return function(){node.detachEvent("on"+type,wrapHandler)}}}}function nodeText(node){return node.textContent||node.innerText||node.nodeValue||""}function nodeTop(node){var top=0;while(node.offsetParent){top+=node.offsetTop;node=node.offsetParent}return top}function isBR(node){var nn=node.nodeName;return nn=="BR"||nn=="br"}function isSpan(node){var nn=node.nodeName;return nn=="SPAN"||nn=="span"};
